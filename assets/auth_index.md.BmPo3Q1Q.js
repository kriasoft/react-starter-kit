import{_ as i,c as a,o as t,a6 as e}from"./chunks/framework.C7CfgHXo.js";const c=JSON.parse('{"title":"Authentication Overview","description":"","frontmatter":{"outline":[2,3]},"headers":[],"relativePath":"auth/index.md","filePath":"auth/index.md","lastUpdated":0}'),n={name:"auth/index.md"};function h(l,s,d,p,r,o){return t(),a("div",null,[...s[0]||(s[0]=[e(`<h1 id="authentication-overview" tabindex="-1">Authentication Overview <a class="header-anchor" href="#authentication-overview" aria-label="Permalink to “Authentication Overview”">​</a></h1><p>Authentication is handled by <a href="https://www.better-auth.com/" target="_blank" rel="noreferrer">Better Auth</a> — a TypeScript-native auth framework that runs entirely in the API worker. The project ships with multiple sign-in methods, organization-based multi-tenancy, and Stripe billing integration out of the box.</p><h2 id="what-s-included" tabindex="-1">What&#39;s Included <a class="header-anchor" href="#what-s-included" aria-label="Permalink to “What&#39;s Included”">​</a></h2><table tabindex="0"><thead><tr><th>Method</th><th>Description</th></tr></thead><tbody><tr><td><a href="./email-otp">Email &amp; OTP</a></td><td>Passwordless 6-digit code via email</td></tr><tr><td><a href="./social-providers">Google OAuth</a></td><td>Social login with redirect flow</td></tr><tr><td><a href="./passkeys">Passkeys</a></td><td>WebAuthn biometric / security key</td></tr><tr><td>Anonymous</td><td>Guest sessions that can be upgraded later</td></tr></tbody></table><p>All methods produce the same session format. Users can link multiple methods to one account.</p><h2 id="plugins" tabindex="-1">Plugins <a class="header-anchor" href="#plugins" aria-label="Permalink to “Plugins”">​</a></h2><p>Better Auth&#39;s functionality is extended through plugins. The server and client must enable matching plugins:</p><table tabindex="0"><thead><tr><th>Plugin</th><th>Server</th><th>Client</th><th>Purpose</th></tr></thead><tbody><tr><td><code>emailOTP</code></td><td><code>emailOTP()</code></td><td><code>emailOTPClient()</code></td><td>Passwordless OTP sign-in</td></tr><tr><td><code>organization</code></td><td><code>organization()</code></td><td><code>organizationClient()</code></td><td>Multi-tenant orgs and roles</td></tr><tr><td><code>passkey</code></td><td><code>passkey()</code></td><td><code>passkeyClient()</code></td><td>WebAuthn authentication</td></tr><tr><td><code>anonymous</code></td><td><code>anonymous()</code></td><td><code>anonymousClient()</code></td><td>Guest sessions</td></tr><tr><td><code>stripe</code></td><td><code>stripe()</code></td><td><code>stripeClient()</code></td><td>Subscription billing</td></tr></tbody></table><p>The Stripe plugin is conditionally loaded — it only activates when <code>STRIPE_SECRET_KEY</code> and related env vars are set. Without them, the app works normally but billing endpoints return 404.</p><h2 id="server-configuration" tabindex="-1">Server Configuration <a class="header-anchor" href="#server-configuration" aria-label="Permalink to “Server Configuration”">​</a></h2><p>The auth instance is created per-request in <code>apps/api/lib/auth.ts</code>:</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// apps/api/lib/auth.ts</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createAuth</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">db</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> DB</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">env</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> AuthEnv</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> betterAuth</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    baseURL: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\`\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">env</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">APP_ORIGIN</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}/api/auth\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    secret: env.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">BETTER_AUTH_SECRET</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    database: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">drizzleAdapter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(db, { provider: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;pg&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, schema: { </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } }),</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    socialProviders: {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      google: {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        clientId: env.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">GOOGLE_CLIENT_ID</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        clientSecret: env.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">GOOGLE_CLIENT_SECRET</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    plugins: [</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      anonymous</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(),</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      organization</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ organizationLimit: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, creatorRole: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;owner&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }),</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      passkey</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ rpID, rpName: env.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">APP_NAME</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, origin: env.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">APP_ORIGIN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }),</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      emailOTP</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ otpLength: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">6</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, expiresIn: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">300</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, allowedAttempts: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }),</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      ...</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">stripePlugin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(db, env),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>The <code>account</code> model is renamed to <code>identity</code> to better describe its purpose (OAuth provider credentials):</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">account</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: { </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">modelName</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;identity&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> },</span></span></code></pre></div><h3 id="id-generation" tabindex="-1">ID Generation <a class="header-anchor" href="#id-generation" aria-label="Permalink to “ID Generation”">​</a></h3><p>All auth tables use prefixed CUID2 IDs generated at the application level:</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">advanced</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  database</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    generateId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: ({ </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">model</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> generateAuthId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(model),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">},</span></span></code></pre></div><p>This produces IDs like <code>usr_cm...</code>, <code>ses_cm...</code>, <code>org_cm...</code> — making it easy to identify what kind of record an ID refers to.</p><h2 id="client-configuration" tabindex="-1">Client Configuration <a class="header-anchor" href="#client-configuration" aria-label="Permalink to “Client Configuration”">​</a></h2><p>The auth client lives in <code>apps/app/lib/auth.ts</code>:</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// apps/app/lib/auth.ts</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { createAuthClient } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;better-auth/react&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> auth</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createAuthClient</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  baseURL: baseURL </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;/api/auth&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  plugins: [</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    anonymousClient</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(),</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    emailOTPClient</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(),</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    organizationClient</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(),</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    passkeyClient</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(),</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    stripeClient</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ subscription: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div><div class="warning custom-block"><p class="custom-block-title custom-block-title-default">WARNING</p><p>Do not use <code>auth.useSession()</code> directly. Session state is managed exclusively through TanStack Query — see <a href="./sessions">Sessions &amp; Protected Routes</a>.</p></div><h2 id="auth-routes" tabindex="-1">Auth Routes <a class="header-anchor" href="#auth-routes" aria-label="Permalink to “Auth Routes”">​</a></h2><p>Better Auth exposes HTTP endpoints at <code>/api/auth/*</code>. These are mounted in the Hono app alongside tRPC:</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>/api/auth/sign-in/*        Sign-in endpoints (email, social, passkey)</span></span>
<span class="line"><span>/api/auth/sign-up/*        Sign-up endpoints</span></span>
<span class="line"><span>/api/auth/sign-out         Session termination</span></span>
<span class="line"><span>/api/auth/get-session      Current session data</span></span>
<span class="line"><span>/api/auth/callback/*       OAuth callbacks</span></span>
<span class="line"><span>/api/auth/email-otp/*      OTP send and verify</span></span>
<span class="line"><span>/api/auth/passkey/*        WebAuthn registration and authentication</span></span>
<span class="line"><span>/api/auth/organization/*   Organization CRUD and membership</span></span></code></pre></div><p>See the <a href="https://www.better-auth.com/docs/api-reference" target="_blank" rel="noreferrer">Better Auth API reference</a> for the full endpoint list.</p><h2 id="database-tables" tabindex="-1">Database Tables <a class="header-anchor" href="#database-tables" aria-label="Permalink to “Database Tables”">​</a></h2><p>Authentication uses 9 database tables defined in <code>db/schema/</code>:</p><table tabindex="0"><thead><tr><th>Table</th><th>File</th><th>Description</th></tr></thead><tbody><tr><td><code>user</code></td><td><code>user.ts</code></td><td>User accounts with profile info</td></tr><tr><td><code>session</code></td><td><code>user.ts</code></td><td>Active sessions with <code>activeOrganizationId</code></td></tr><tr><td><code>identity</code></td><td><code>user.ts</code></td><td>OAuth provider credentials (Better Auth&#39;s <code>account</code> model)</td></tr><tr><td><code>verification</code></td><td><code>user.ts</code></td><td>Email verification and OTP tokens</td></tr><tr><td><code>organization</code></td><td><code>organization.ts</code></td><td>Tenant organizations</td></tr><tr><td><code>member</code></td><td><code>organization.ts</code></td><td>Organization memberships with roles</td></tr><tr><td><code>invitation</code></td><td><code>invitation.ts</code></td><td>Pending org invitations</td></tr><tr><td><code>passkey</code></td><td><code>passkey.ts</code></td><td>WebAuthn credential store</td></tr><tr><td><code>subscription</code></td><td><code>subscription.ts</code></td><td>Stripe subscription state</td></tr></tbody></table><h2 id="auth-hint-cookie" tabindex="-1">Auth Hint Cookie <a class="header-anchor" href="#auth-hint-cookie" aria-label="Permalink to “Auth Hint Cookie”">​</a></h2><p>The API worker sets a lightweight cookie (<code>__Host-auth</code> in HTTPS, <code>auth</code> in HTTP dev) on sign-in and clears it on sign-out. The web edge worker reads this cookie to route <code>/</code> — authenticated users get the app, anonymous users get the marketing page. This cookie is a routing hint only, not a security boundary. See <a href="/adr/001-auth-hint-cookie">ADR-001</a> for the full rationale.</p><h2 id="environment-variables" tabindex="-1">Environment Variables <a class="header-anchor" href="#environment-variables" aria-label="Permalink to “Environment Variables”">​</a></h2><table tabindex="0"><thead><tr><th>Variable</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>BETTER_AUTH_SECRET</code></td><td>Yes</td><td>Secret for signing sessions and tokens</td></tr><tr><td><code>GOOGLE_CLIENT_ID</code></td><td>Yes</td><td>Google OAuth client ID</td></tr><tr><td><code>GOOGLE_CLIENT_SECRET</code></td><td>Yes</td><td>Google OAuth client secret</td></tr><tr><td><code>RESEND_API_KEY</code></td><td>Yes</td><td>API key for sending OTP emails</td></tr><tr><td><code>RESEND_EMAIL_FROM</code></td><td>Yes</td><td>Sender address for auth emails</td></tr><tr><td><code>APP_NAME</code></td><td>Yes</td><td>Display name (used in emails and passkey prompts)</td></tr><tr><td><code>APP_ORIGIN</code></td><td>Yes</td><td>Full origin URL (e.g., <code>https://example.com</code>)</td></tr></tbody></table>`,33)])])}const E=i(n,[["render",h]]);export{c as __pageData,E as default};
