import{_ as i,c as a,o as e,a6 as t}from"./chunks/framework.C7CfgHXo.js";const c=JSON.parse('{"title":"Email & OTP","description":"","frontmatter":{"outline":[2,3]},"headers":[],"relativePath":"auth/email-otp.md","filePath":"auth/email-otp.md","lastUpdated":0}'),n={name:"auth/email-otp.md"};function l(h,s,p,k,d,r){return e(),a("div",null,[...s[0]||(s[0]=[t(`<h1 id="email-otp" tabindex="-1">Email &amp; OTP <a class="header-anchor" href="#email-otp" aria-label="Permalink to “Email &amp; OTP”">​</a></h1><p>The primary sign-in method is passwordless email OTP. Users enter their email, receive a 6-digit code, and enter it to authenticate. The same flow handles both login and signup — if the email doesn&#39;t exist, Better Auth creates the account automatically.</p><h2 id="server-configuration" tabindex="-1">Server Configuration <a class="header-anchor" href="#server-configuration" aria-label="Permalink to “Server Configuration”">​</a></h2><p>The <code>emailOTP</code> plugin is configured in <code>apps/api/lib/auth.ts</code>:</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">emailOTP</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  async</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sendVerificationOTP</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">email</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">otp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sendOTP</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(env, { email, otp, type });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  otpLength: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">6</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  expiresIn: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">300</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,      </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 5 minutes</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  allowedAttempts: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,   </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// max wrong guesses before code is invalidated</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}),</span></span></code></pre></div><p>OTP codes are stored in the <code>verification</code> table and automatically expire. After 3 failed attempts, the code is invalidated and the user must request a new one.</p><h3 id="email-delivery" tabindex="-1">Email Delivery <a class="header-anchor" href="#email-delivery" aria-label="Permalink to “Email Delivery”">​</a></h3><p>OTP emails are sent via <a href="https://react.email/" target="_blank" rel="noreferrer">React Email</a> templates rendered to HTML + plain text, delivered through <a href="https://resend.com/" target="_blank" rel="noreferrer">Resend</a>:</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// apps/api/lib/email.ts</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sendOTP</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">env</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, { </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">email</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">otp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // In development, OTP is also printed to the console</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (env.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">ENVIRONMENT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;development&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\`OTP code for \${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">email</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}: \${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">otp</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> component</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OTPEmail</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ otp, type, appName: env.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">APP_NAME</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> });</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> html</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> renderEmailToHtml</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(component);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> text</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> renderEmailToText</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(component);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sendEmail</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(env, {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    to: email,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    subject: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\`Your Sign In code\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    html,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    text,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><div class="tip custom-block"><p class="custom-block-title custom-block-title-default">TIP</p><p>During local development, OTP codes are logged to the terminal — you don&#39;t need a real Resend API key to test the flow.</p></div><h2 id="client-flow" tabindex="-1">Client Flow <a class="header-anchor" href="#client-flow" aria-label="Permalink to “Client Flow”">​</a></h2><p>The auth form implements a 3-step state machine:</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>method → email → otp</span></span></code></pre></div><p>Each step is a separate UI component orchestrated by <code>AuthForm</code>:</p><table tabindex="0"><thead><tr><th>Step</th><th>Component</th><th>What Happens</th></tr></thead><tbody><tr><td><code>method</code></td><td><code>MethodSelection</code></td><td>User picks sign-in method (Google, email, passkey)</td></tr><tr><td><code>email</code></td><td><code>EmailInput</code></td><td>User enters email, OTP is sent</td></tr><tr><td><code>otp</code></td><td><code>OtpVerification</code></td><td>User enters 6-digit code to complete sign-in</td></tr></tbody></table><h3 id="state-machine" tabindex="-1">State Machine <a class="header-anchor" href="#state-machine" aria-label="Permalink to “State Machine”">​</a></h3><p>The state transitions are defined in <code>apps/app/components/auth/use-auth-form.ts</code>:</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> VALID_TRANSITIONS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Record</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">AuthStep</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">AuthStep</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[]&gt; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  method: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;email&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  email: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;method&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;otp&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  otp: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;email&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre></div><p>Transitions are validated — invalid step jumps are silently ignored. This prevents race conditions from concurrent auth operations (e.g., passkey conditional UI completing while the user clicks a button).</p><h3 id="sending-the-otp" tabindex="-1">Sending the OTP <a class="header-anchor" href="#sending-the-otp" aria-label="Permalink to “Sending the OTP”">​</a></h3><p>When the user submits their email, the <code>sendOtp</code> function normalizes the input and calls the Better Auth client:</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// &quot;sign-in&quot; type handles both login and signup</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> result</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> auth.emailOtp.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sendVerificationOtp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  email: normalizedEmail,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  type: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;sign-in&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div><p>The <code>sign-in</code> type is used for both login and signup flows. Better Auth creates the user account if the email is new.</p><h3 id="verifying-the-code" tabindex="-1">Verifying the Code <a class="header-anchor" href="#verifying-the-code" aria-label="Permalink to “Verifying the Code”">​</a></h3><p>The <code>OtpVerification</code> component handles code entry and verification:</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> result</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> auth.signIn.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">emailOtp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ email, otp });</span></span></code></pre></div><p>The input field restricts to 6 numeric digits with <code>inputMode=&quot;numeric&quot;</code> and <code>autoComplete=&quot;one-time-code&quot;</code> for mobile OTP autofill.</p><h2 id="error-handling" tabindex="-1">Error Handling <a class="header-anchor" href="#error-handling" aria-label="Permalink to “Error Handling”">​</a></h2><p>The OTP plugin returns specific error codes that map to user-friendly messages:</p><table tabindex="0"><thead><tr><th>Error Code</th><th>User Message</th><th>Behavior</th></tr></thead><tbody><tr><td><code>TOO_MANY_ATTEMPTS</code></td><td>&quot;Too many failed attempts. Please request a new code.&quot;</td><td>Returns to email step</td></tr><tr><td><code>OTP_EXPIRED</code></td><td>&quot;Code has expired. Please request a new one.&quot;</td><td>Returns to email step</td></tr><tr><td><code>INVALID_OTP</code></td><td>&quot;Invalid verification code&quot;</td><td>Stays on OTP step (can retry)</td></tr></tbody></table><p>When <code>TOO_MANY_ATTEMPTS</code> or <code>OTP_EXPIRED</code> occurs, the form automatically returns to the email step so the user can request a fresh code.</p><h3 id="resend-cooldown" tabindex="-1">Resend Cooldown <a class="header-anchor" href="#resend-cooldown" aria-label="Permalink to “Resend Cooldown”">​</a></h3><p>After the initial OTP is sent, users can request a new code with a 30-second cooldown:</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> RESEND_COOLDOWN_SECONDS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 30</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><p>The resend button shows a countdown timer and is disabled during the cooldown period.</p><h2 id="component-architecture" tabindex="-1">Component Architecture <a class="header-anchor" href="#component-architecture" aria-label="Permalink to “Component Architecture”">​</a></h2><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>AuthForm</span></span>
<span class="line"><span>├── MethodSelection          Step 1: choose sign-in method</span></span>
<span class="line"><span>│   ├── GoogleLogin          OAuth redirect</span></span>
<span class="line"><span>│   ├── &quot;Continue with email&quot; button</span></span>
<span class="line"><span>│   └── PasskeyLogin         WebAuthn (login only)</span></span>
<span class="line"><span>├── EmailInput               Step 2: enter email, send OTP</span></span>
<span class="line"><span>└── OtpStep</span></span>
<span class="line"><span>    └── OtpVerification      Step 3: enter code, verify</span></span></code></pre></div><p>The <code>AuthForm</code> accepts a <code>mode</code> prop (<code>&quot;login&quot;</code> or <code>&quot;signup&quot;</code>) that controls copy and available methods. Both modes use the same OTP flow — the difference is cosmetic (headings, ToS display, passkey availability).</p><div class="info custom-block"><p class="custom-block-title custom-block-title-default">INFO</p><p>Passkeys are only shown during login. They require an existing account with a registered passkey — see <a href="./passkeys">Passkeys</a>.</p></div>`,39)])])}const E=i(n,[["render",l]]);export{c as __pageData,E as default};
