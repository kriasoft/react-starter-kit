import{_ as t,o as a,c as i,a6 as r}from"./chunks/framework.BvqLMprX.js";const b=JSON.parse('{"title":"Billing","description":"","frontmatter":{"outline":[2,3]},"headers":[],"relativePath":"billing/index.md","filePath":"billing/index.md","lastUpdated":1771429567000}'),d={name:"billing/index.md"};function n(s,e,o,l,c,p){return a(),i("div",null,[...e[0]||(e[0]=[r(`<div style="display:none;" hidden="true" aria-hidden="true">Are you an LLM? You can read better optimized documentation at /billing.md for this page in Markdown format</div><h1 id="billing" tabindex="-1">Billing <a class="header-anchor" href="#billing" aria-label="Permalink to “Billing”">​</a></h1><p>Stripe subscriptions are integrated via the <a href="https://www.better-auth.com/docs/plugins/stripe" target="_blank" rel="noreferrer"><code>@better-auth/stripe</code></a> plugin. The auth system manages the full subscription lifecycle – customer creation, checkout, webhooks, and status tracking – so billing state lives alongside sessions and organizations in the same database.</p><p>Billing is <strong>optional</strong> – without the <code>STRIPE_*</code> environment variables the app works normally; billing endpoints return 404 and the UI falls back to the free plan.</p><h2 id="what-s-included" tabindex="-1">What&#39;s Included <a class="header-anchor" href="#what-s-included" aria-label="Permalink to “What&#39;s Included”">​</a></h2><table tabindex="0"><thead><tr><th>Feature</th><th>Implementation</th></tr></thead><tbody><tr><td>Three-tier plans (Free / Starter / Pro)</td><td>Config in <code>apps/api/lib/plans.ts</code></td></tr><tr><td>Stripe hosted checkout</td><td><code>auth.subscription.upgrade()</code> client method</td></tr><tr><td>Customer portal (cancel, change card)</td><td><code>auth.subscription.billingPortal()</code></td></tr><tr><td>Org-level and personal billing</td><td><code>referenceId</code> derived from session</td></tr><tr><td>Webhook-driven status sync</td><td>Plugin-managed endpoint</td></tr><tr><td>14-day free trial on Pro</td><td><code>freeTrial: { days: 14 }</code> in plan config</td></tr><tr><td>Annual discount pricing</td><td><code>annualDiscountPriceId</code> on Pro plan</td></tr></tbody></table><h2 id="architecture" tabindex="-1">Architecture <a class="header-anchor" href="#architecture" aria-label="Permalink to “Architecture”">​</a></h2><div class="language-text"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>┌─────────────┐     POST /api/auth/subscription/upgrade      ┌───────────────┐</span></span>
<span class="line"><span>│   Browser   │ ──────────────────────────────────────────→  │  API Worker   │</span></span>
<span class="line"><span>│    (app)    │                                              │    (Hono)     │</span></span>
<span class="line"><span>│             │  ←── 302 redirect                            │               │</span></span>
<span class="line"><span>│             │──→ Stripe Checkout (hosted)                  │  Better Auth  │</span></span>
<span class="line"><span>│             │                                              │  + stripe()   │</span></span>
<span class="line"><span>│             │    POST /api/auth/stripe/webhook             │  plugin       │</span></span>
<span class="line"><span>│             │                              Stripe ────────→│  webhook ──→  │</span></span>
<span class="line"><span>│             │                                              │  update DB    │</span></span>
<span class="line"><span>│             │    GET  /api/trpc/billing.subscription       │               │</span></span>
<span class="line"><span>│             │ ──────────────────────────────────────────→  │  tRPC router  │</span></span>
<span class="line"><span>└─────────────┘  ←── subscription data (TanStack Query)      └───────────────┘</span></span></code></pre></div><ol><li>User clicks <strong>Upgrade</strong> – auth client calls <code>auth.subscription.upgrade()</code></li><li>Plugin creates a Stripe Checkout session – redirects browser to Stripe</li><li>User completes payment – Stripe sends webhook to <code>/api/auth/stripe/webhook</code></li><li>Plugin verifies signature, updates <code>subscription</code> table</li><li>Client refetches billing state via tRPC + TanStack Query</li></ol><p>Mutations (upgrade, portal) go through the auth client because the plugin handles Stripe API calls, session validation, and org authorization internally. Reads go through tRPC to benefit from TanStack Query caching and org-aware cache keys.</p><h2 id="billing-reference" tabindex="-1">Billing Reference <a class="header-anchor" href="#billing-reference" aria-label="Permalink to “Billing Reference”">​</a></h2><p>Billing is tied to <code>session.activeOrganizationId</code> when present; otherwise falls back to <code>user.id</code> for personal use. One active subscription per reference ID.</p><table tabindex="0"><thead><tr><th>Context</th><th><code>referenceId</code></th><th>Who can manage</th></tr></thead><tbody><tr><td>Organization active</td><td><code>activeOrganizationId</code></td><td>Owner or admin</td></tr><tr><td>No organization</td><td><code>user.id</code></td><td>The user</td></tr></tbody></table><p>The server derives <code>referenceId</code> from the session – no client-side parameter needed. The billing query key includes <code>activeOrgId</code>, so switching organizations refetches automatically.</p><h2 id="plans" tabindex="-1">Plans <a class="header-anchor" href="#plans" aria-label="Permalink to “Plans”">​</a></h2><p>Three tiers with enforced member limits:</p><table tabindex="0"><thead><tr><th>Plan</th><th>Members</th><th>Trial</th><th>Price ID env var</th></tr></thead><tbody><tr><td>Free</td><td>1</td><td>–</td><td>–</td></tr><tr><td>Starter</td><td>5</td><td>–</td><td><code>STRIPE_STARTER_PRICE_ID</code></td></tr><tr><td>Pro</td><td>50</td><td>14 days</td><td><code>STRIPE_PRO_PRICE_ID</code></td></tr></tbody></table><p>See <a href="./plans">Plans &amp; Pricing</a> for configuration details.</p><h2 id="environment-variables" tabindex="-1">Environment Variables <a class="header-anchor" href="#environment-variables" aria-label="Permalink to “Environment Variables”">​</a></h2><table tabindex="0"><thead><tr><th>Variable</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>STRIPE_SECRET_KEY</code></td><td>For billing</td><td>Stripe secret key (<code>sk_test_...</code> / <code>sk_live_...</code>)</td></tr><tr><td><code>STRIPE_WEBHOOK_SECRET</code></td><td>For billing</td><td>Webhook signing secret (<code>whsec_...</code>)</td></tr><tr><td><code>STRIPE_STARTER_PRICE_ID</code></td><td>For billing</td><td>Stripe price ID for Starter plan (<code>price_...</code>)</td></tr><tr><td><code>STRIPE_PRO_PRICE_ID</code></td><td>For billing</td><td>Stripe price ID for Pro plan (<code>price_...</code>)</td></tr><tr><td><code>STRIPE_PRO_ANNUAL_PRICE_ID</code></td><td>Optional</td><td>Annual discount price for Pro plan (<code>price_...</code>)</td></tr></tbody></table><p>Set in <code>.env.local</code> for development, Cloudflare secrets for staging/production. See <a href="/getting-started/environment-variables">Environment Variables</a>.</p><h2 id="file-map" tabindex="-1">File Map <a class="header-anchor" href="#file-map" aria-label="Permalink to “File Map”">​</a></h2><table tabindex="0"><thead><tr><th>Layer</th><th>Files</th></tr></thead><tbody><tr><td>Schema</td><td><code>db/schema/subscription.ts</code>, <code>stripeCustomerId</code> on user + organization tables</td></tr><tr><td>Server</td><td><code>apps/api/lib/plans.ts</code>, <code>apps/api/lib/stripe.ts</code>, stripe plugin in <code>apps/api/lib/auth.ts</code></td></tr><tr><td>Router</td><td><code>apps/api/routers/billing.ts</code></td></tr><tr><td>Client</td><td><code>stripeClient</code> in <code>apps/app/lib/auth.ts</code>, <code>apps/app/lib/queries/billing.ts</code></td></tr><tr><td>UI</td><td>Billing card in <code>apps/app/routes/(app)/settings.tsx</code></td></tr></tbody></table>`,23)])])}const u=t(d,[["render",n]]);export{b as __pageData,u as default};
