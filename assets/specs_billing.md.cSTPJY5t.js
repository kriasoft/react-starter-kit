import{_ as a,o as i,c as t,a6 as s}from"./chunks/framework.BvqLMprX.js";const u=JSON.parse('{"title":"Stripe Billing Integration","description":"","frontmatter":{},"headers":[],"relativePath":"specs/billing.md","filePath":"specs/billing.md","lastUpdated":1771429567000}'),n={name:"specs/billing.md"};function o(r,e,l,d,c,p){return i(),t("div",null,[...e[0]||(e[0]=[s(`<div style="display:none;" hidden="true" aria-hidden="true">Are you an LLM? You can read better optimized documentation at /specs/billing.md for this page in Markdown format</div><h1 id="stripe-billing-integration" tabindex="-1">Stripe Billing Integration <a class="header-anchor" href="#stripe-billing-integration" aria-label="Permalink to “Stripe Billing Integration”">​</a></h1><h2 id="overview" tabindex="-1">Overview <a class="header-anchor" href="#overview" aria-label="Permalink to “Overview”">​</a></h2><p>Stripe billing via <code>@better-auth/stripe</code> plugin. Billing is tightly coupled with auth – customer lifecycle, subscription state, and webhook handling are managed by the same system that manages sessions and organizations.</p><p><strong>Non-goals:</strong> Usage-based billing, metered pricing, one-time payments, invoicing, Stripe Elements/embedded checkout, tax calculation, multi-currency. These can be added incrementally.</p><h2 id="decision-rationale" tabindex="-1">Decision Rationale <a class="header-anchor" href="#decision-rationale" aria-label="Permalink to “Decision Rationale”">​</a></h2><p><strong>Better Auth plugin over raw Stripe SDK:</strong> RSK already uses Better Auth for auth, organizations, and sessions. The plugin handles customer sync, subscription lifecycle, webhook verification, and org-level billing – eliminating significant glue code.</p><p><strong>Hosted Checkout over embedded Elements:</strong> Stripe Checkout is PCI-compliant out of the box, requires no <code>@stripe/stripe-js</code> client dependency, and handles payment method selection, 3D Secure, and receipts. The upgrade path to embedded Elements exists but isn&#39;t needed initially.</p><p><strong><code>createCustomerOnSignUp: true</code>:</strong> Creates Stripe customer records eagerly on signup. Simplifies the upgrade flow and enables Stripe-side analytics. Trade-off: creates unused records for users who never upgrade.</p><h2 id="architecture" tabindex="-1">Architecture <a class="header-anchor" href="#architecture" aria-label="Permalink to “Architecture”">​</a></h2><div class="language-text"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>┌─────────────┐     POST /api/auth/subscription/upgrade      ┌───────────────┐</span></span>
<span class="line"><span>│   Browser   │ ──────────────────────────────────────────→  │  API Worker   │</span></span>
<span class="line"><span>│    (app)    │                                              │    (Hono)     │</span></span>
<span class="line"><span>│             │  ←── 302 redirect                            │               │</span></span>
<span class="line"><span>│             │──→ Stripe Checkout (hosted)                  │  Better Auth  │</span></span>
<span class="line"><span>│             │                                              │  + stripe()   │</span></span>
<span class="line"><span>│             │    POST /api/auth/stripe/webhook             │  plugin       │</span></span>
<span class="line"><span>│             │                                              │               │</span></span>
<span class="line"><span>│             │                              Stripe ────────→│  webhook ──→  │</span></span>
<span class="line"><span>│             │                                              │  update DB    │</span></span>
<span class="line"><span>│             │    GET  /api/trpc/billing.subscription       │               │</span></span>
<span class="line"><span>│             │ ──────────────────────────────────────────→  │  tRPC router  │</span></span>
<span class="line"><span>└─────────────┘  ←── subscription data (TanStack Query)      └───────────────┘</span></span></code></pre></div><p><strong>Data flow:</strong></p><ol><li>User clicks &quot;Upgrade&quot; – Better Auth client calls <code>auth.subscription.upgrade()</code></li><li>Plugin creates Stripe Checkout session – redirects browser to Stripe</li><li>User completes payment – Stripe sends webhook to <code>/api/auth/stripe/webhook</code></li><li>Plugin verifies signature, updates <code>subscription</code> table – client refetches via tRPC</li></ol><p><strong>Why tRPC for reads, Better Auth client for mutations:</strong> Subscription queries benefit from TanStack Query caching, batching, and stale-while-revalidate. Mutations (upgrade, cancel, portal) go through the auth client because the plugin handles Stripe API calls, session validation, and org authorization internally.</p><h2 id="billing-reference" tabindex="-1">Billing Reference <a class="header-anchor" href="#billing-reference" aria-label="Permalink to “Billing Reference”">​</a></h2><p>Billing is tied to <code>session.activeOrganizationId</code> when present; otherwise falls back to <code>user.id</code> for personal use. The plugin enforces one active subscription per reference ID.</p><ul><li><strong>Organization context:</strong> <code>referenceId = activeOrganizationId</code> – only org owner/admin can manage billing</li><li><strong>No organization:</strong> <code>referenceId = user.id</code> – user manages their own subscription</li><li>The server derives <code>referenceId</code> from the session – no client-side param needed</li><li>The billing query key includes <code>activeOrgId</code>, so switching organizations automatically fetches fresh billing data via TanStack Query</li></ul><h2 id="database-schema" tabindex="-1">Database Schema <a class="header-anchor" href="#database-schema" aria-label="Permalink to “Database Schema”">​</a></h2><p>The plugin uses <code>stripeCustomerId</code> on the <code>user</code> and <code>organization</code> tables, and a <code>subscription</code> table. The plugin manages the subscription table – no manual inserts/updates needed.</p><p>Schema must match plugin expectations. After auth config changes, update the schema in <code>db/schema/</code> and run <code>bun db:generate</code> to create migrations.</p><h2 id="plan-configuration" tabindex="-1">Plan Configuration <a class="header-anchor" href="#plan-configuration" aria-label="Permalink to “Plan Configuration”">​</a></h2><p>Plan limits defined in <code>apps/api/lib/plans.ts</code> (single source of truth), referenced by both auth plugin config and tRPC router. Price IDs come from environment variables (<code>STRIPE_*_PRICE_ID</code>).</p><p>Config-as-code is the simplest correct approach – plans rarely change and this makes them testable and version-controlled.</p><p><strong>Escape hatch:</strong> The plugin accepts <code>plans: () =&gt; StripePlan[]</code> for dynamic plans. Switch to this only when a real use case requires runtime plan management (e.g., admin dashboard for plan CRUD).</p><p><strong>Limits enforcement:</strong> The <code>limits</code> object is returned by the <code>billing.subscription</code> tRPC query. Enforce limits in application logic (tRPC middleware, UI guards), not in the plugin itself.</p><h2 id="environment-variables" tabindex="-1">Environment Variables <a class="header-anchor" href="#environment-variables" aria-label="Permalink to “Environment Variables”">​</a></h2><table tabindex="0"><thead><tr><th>Variable</th><th>Prefix</th></tr></thead><tbody><tr><td><code>STRIPE_SECRET_KEY</code></td><td><code>sk_</code></td></tr><tr><td><code>STRIPE_WEBHOOK_SECRET</code></td><td><code>whsec_</code></td></tr><tr><td><code>STRIPE_STARTER_PRICE_ID</code></td><td><code>price_</code></td></tr><tr><td><code>STRIPE_PRO_PRICE_ID</code></td><td><code>price_</code></td></tr><tr><td><code>STRIPE_PRO_ANNUAL_PRICE_ID</code></td><td><code>price_</code></td></tr></tbody></table><p>Set in <code>.env.local</code> (local dev), Cloudflare secrets (staging/prod).</p><h2 id="webhook-setup" tabindex="-1">Webhook Setup <a class="header-anchor" href="#webhook-setup" aria-label="Permalink to “Webhook Setup”">​</a></h2><p>The plugin registers <code>POST /api/auth/stripe/webhook</code> automatically. It handles:</p><ul><li><code>checkout.session.completed</code> – activates subscription</li><li><code>customer.subscription.created</code> – records new subscription</li><li><code>customer.subscription.updated</code> – syncs status, cancellation scheduling</li><li><code>customer.subscription.deleted</code> – marks subscription canceled</li></ul><h3 id="stripe-dashboard-configuration" tabindex="-1">Stripe Dashboard Configuration <a class="header-anchor" href="#stripe-dashboard-configuration" aria-label="Permalink to “Stripe Dashboard Configuration”">​</a></h3><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>Endpoint URL: https://&lt;domain&gt;/api/auth/stripe/webhook</span></span>
<span class="line"><span>Events:</span></span>
<span class="line"><span>  - checkout.session.completed</span></span>
<span class="line"><span>  - customer.subscription.created</span></span>
<span class="line"><span>  - customer.subscription.updated</span></span>
<span class="line"><span>  - customer.subscription.deleted</span></span></code></pre></div><h3 id="local-development" tabindex="-1">Local Development <a class="header-anchor" href="#local-development" aria-label="Permalink to “Local Development”">​</a></h3><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">stripe</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> listen</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --forward-to</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> localhost:5173/api/auth/stripe/webhook</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Copy the whsec_... signing secret to .env.local</span></span></code></pre></div><h3 id="raw-body-requirement" tabindex="-1">Raw Body Requirement <a class="header-anchor" href="#raw-body-requirement" aria-label="Permalink to “Raw Body Requirement”">​</a></h3><p>Stripe webhook verification requires the raw request body. The plugin handles this via <code>request.text()</code> – no special Hono middleware needed.</p><h2 id="testing" tabindex="-1">Testing <a class="header-anchor" href="#testing" aria-label="Permalink to “Testing”">​</a></h2><p>The plugin tests its own internals (webhooks, checkout, subscription lifecycle, authorization). App tests cover the seams we own:</p><ul><li><strong>Router</strong> (<code>apps/api/routers/billing.test.ts</code>) – free plan fallback, plan limits mapping, unknown plan rejection, response shape</li><li><strong>Query</strong> (<code>apps/app/lib/queries/billing.test.ts</code>) – cache key includes org ID, null normalization, distinct keys per org, prefix for bulk invalidation</li></ul><p>Checkout and webhook flows are not retested at app level – verified via <code>stripe listen</code> during development.</p><h2 id="file-map" tabindex="-1">File Map <a class="header-anchor" href="#file-map" aria-label="Permalink to “File Map”">​</a></h2><table tabindex="0"><thead><tr><th>Layer</th><th>Files</th></tr></thead><tbody><tr><td>Schema</td><td><code>db/schema/subscription.ts</code>, <code>stripeCustomerId</code> in <code>db/schema/user.ts</code> and <code>db/schema/organization.ts</code></td></tr><tr><td>Server</td><td><code>apps/api/lib/plans.ts</code>, <code>apps/api/lib/stripe.ts</code>, stripe plugin in <code>apps/api/lib/auth.ts</code></td></tr><tr><td>Router</td><td><code>apps/api/routers/billing.ts</code>, registered in <code>apps/api/lib/app.ts</code></td></tr><tr><td>Client</td><td><code>stripeClient</code> in <code>apps/app/lib/auth.ts</code>, <code>apps/app/lib/queries/billing.ts</code></td></tr><tr><td>UI</td><td>Billing card in <code>apps/app/routes/(app)/settings.tsx</code></td></tr><tr><td>Tests</td><td><code>apps/api/routers/billing.test.ts</code>, <code>apps/app/lib/queries/billing.test.ts</code></td></tr></tbody></table>`,43)])])}const g=a(n,[["render",o]]);export{u as __pageData,g as default};
